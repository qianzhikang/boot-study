# 日志框架

## 门面模式

门面模式：屏蔽底层实现逻辑，都使用同一种使用方式。

![image-20220411134121220](https://pic-go.oss-cn-shanghai.aliyuncs.com/typora-img/202204111341297.png)

## 使用方式

> @Sl4j注解

![image-20220411141149812](https://pic-go.oss-cn-shanghai.aliyuncs.com/typora-img/202204111411846.png)

> 定义logger变量
>
> `private static final Logger logger = LoggerFactory.getLogger(TestController.class);`

![](https://pic-go.oss-cn-shanghai.aliyuncs.com/typora-img/202204111342050.png)



## 日志级别

- TRACE：追踪。一般上对核心系统进行性能调试或者跟踪问题时有用，级别很低，一般不开启。
- DEBUG：调试。打印记录运行信息。
- INFO：信息。记录交互信息，一些参数等，方便定位问题，或者还原现场环境使用。比较重要。
- WARN警告。记录潜在的可能会引发错误的信息。比如启动时某某配置文件不存在或者参数没有设置等等。
- ERROR: 错误。比较常见，一般是捕获异常时输出，虽然发生了错误，但不影响正常运行。可能导致系统出错或者宕机。



## logback日志

### logback的配置

> application配置文件实现日志配置

```yml
logging:
  level:
    root: info
    com.qzk.boot.controller: debug
  file:
    path: 'C:\Users\Courage\Desktop\logs'
    name: 'C:\Users\Courage\Desktop\logs\boot-log.log'
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 7
  pattern:
    console: "%red(%d{yyyy-MM-dd HH:mm:ss}) %green([%thread]) %highlight(%-5level) %boldMagenta(%logger{10} - %cyan(%msg%n))"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger : %msg%n"
```

配置项的具体意义：

- level.root 配置日志的级别
- com.xxxx.xxx.xxx 配置这个包下的类 日志打印的级别
- file.path 配置日志文件生成的目录
- file.name 配置日志文件生成的名字，（必须全路径名）
- logback.rollingpolicy 配置日志的一些回滚策略
  - max-file-size 配置单日志文件的最大大小
  - max-history 配置日志文件再服务器上的最大存活时间（天）
- pattern.console 配置控制台输出日志的颜色、加粗等
- pattern.file 配置输出到文件中的日志格式



> xml配置文件实现多环境下，配置的切换
>
> 通过yml中的spring.profile.active: xxx就可以进行切换了

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!--引入默认的一些设置-->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    <!--web信息-->
    <logger name="org.springframework.web" level="info"/>

    <!--写入日志到控制台的appender,去掉charset,否则有可能Windows系统下tomcat下乱码-->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${CONSOLE_LOG_PATTERN}</pattern>
        </encoder>
    </appender>

    <!--定义日志文件的存储地址，不要在 LogBack 的配置中使用相对路径-->
    <property name="LOG_PATH" value="C:\Users\Courage\Desktop\logs"/>

    <!--写入日志到文件的appender-->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!--日志文件输出的文件名,每天一个文件-->
            <FileNamePattern>${LOG_PATH}/%d{yyyy-MM-dd}.log</FileNamePattern>
            <!--日志文件保留天数-->
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</pattern>
        </encoder>
        <!--日志文件最大的大小-->
        <triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy">
            <MaxFileSize>10MB</MaxFileSize>
        </triggeringPolicy>
    </appender>

    <!--异步写日志到文件-->
    <appender name="asyncFileAppender" class="ch.qos.logback.classic.AsyncAppender">
        <discardingThreshold>0</discardingThreshold>
        <queueSize>500</queueSize>
        <appender-ref ref="FILE"/>
    </appender>

    <!--生产环境:打印控制台和输出到文件-->
    <springProfile name="prod">
        <root level="info">
            <appender-ref ref="FILE"/>
            <!--<appender-ref ref="asyncFileAppender"/>-->
        </root>
    </springProfile>

    <!--开发环境:打印控制台-->
    <springProfile name="dev">
        <!-- 打印sql -->
        <logger name="com.qzk.boot.controller" level="DEBUG"/>
        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!--测试环境:打印控制台-->
    <springProfile name="test">
        <root level="info">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>
</configuration>
```

> logback中的日志占位符

- `%red(%d{yyyy-MM-dd HH:mm:ss})`表示红色字体，日志输出时间
- `%green([%thread])` 表示绿色的，输出日志的线程的名字
- `%highlight(%-5level)` `%highlight`：高亮；`%-5level`5个字符靠左对齐（`5-`为靠右对齐）的日志级别
- `%boldMagenta(%logger{10} - %cyan(%msg%n))` `%boldMagenta`粗体洋红色；`%logger{10}`输出日志的类的名字；`%cyan`青色；`%msg` 日志消息；`%n`换行

## log4j2日志

首先需要排除springboot自带的logback日志框架：

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
    <!--排除logback-->
    <exclusions>
        <exclusion>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-logging</artifactId>
        </exclusion>
    </exclusions>
</dependency>
<!--log4j2依赖-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-log4j2</artifactId>
</dependency>
```

编写log4j2的xml配置文件、放在resources更目录：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <properties>
        <!--日志输出位置-->
        <property name="LOG_HOME">C:\Users\Courage\Desktop\logs</property>
    </properties>

    <Appenders>
        <!-- 将日志输出到控制台-->
        <Console name="CONSOLE" target="SYSTEM_OUT">
            <!--设置日志格式及颜色-->
            <PatternLayout
                    pattern="[%style{%d}{bright,green}][%highlight{%p}][%style{%t}{bright,blue}][%style{%C}{bright,yellow}]: %msg%n%style{%throwable}{red}"
                    disableAnsi="false" noConsoleNoAnsi="false"/>
        </Console>

        <!-- 将日志输出到文件-->
        <RollingFile name="FILE-APPENDER"
                     fileName="${LOG_HOME}/log4j2-demo.log"
                     filePattern="${LOG_HOME}/log4j2-demo-%d{yyyy-MM-dd}-%i.log">
            <!--设置日志格式-->
            <PatternLayout>
                <pattern>[%d][%p][%t][%C] %m%n</pattern>
            </PatternLayout>
            <Policies>
                <!-- 设置日志文件切分参数 -->
                <SizeBasedTriggeringPolicy size="100 MB"/>
                <TimeBasedTriggeringPolicy/>
            </Policies>
            <!--设置最大存档数-->
            <DefaultRolloverStrategy max="20"/>
        </RollingFile>
    </Appenders>

    <Loggers>
        <!-- 根日志设置 -->
        <Root level="debug">
            <AppenderRef ref="CONSOLE" level="debug"/>
            <AppenderRef ref="FILE-APPENDER" level="info"/>
        </Root>
        <!--spring日志-->
        <Logger name="org.springframework" level="info"/>
        <!-- mybatis日志 -->
        <Logger name="com.mybatis" level="warn"/>
    </Loggers>
</configuration>
```

### log4j2的配置详解

- `<property>` 可以进行一些目录等的参数，在下面的配置中引用，使用`name`指定，并在下文使用`${name}`调用
- `<Appenders>` 进行一些个性化的日志的配置

  - `<Console name="CONSOLE" target="SYSTEM_OUT">` 将日志输出到控制台

    - `<PatternLayout/>`设置日志格式及颜色

  - `<RollingFile>` 将日志输出到文件的一些配置
- `<Loggers>` 进行不同环境下日志输出的级别管理
  - `<Root>`根日志设置
    - `<AppenderRef>` 使用 `ref`属性调用上文的配置，使用name属性调用，设置不同环境下输出的日志格式和级别
  - `<Logger>`可以指定不同的包下的类打印不同级别的日志