# Spring Boot Actuator应用程序监控

## 简介

Spring Boot作为构建微服务节点的方案，一定要提供全面而且细致的监控指标，使微服务更易于管理！微服务不同于单体应用，微服务的每个服务节点都单独部署，独立运行，大型的微服务项目甚至有成百上千个服务节点。这就为我们进行系统监控与运维提出了挑战。为了应对这个挑战，其中最重要的工作之一就是：微服务节点能够合理的暴露服务的相关监控指标，用以对服务进行健康检查、监控管理，从而进行合理的流量规划与安排系统运维工作！

## 生产级别功能

- 健康检查
- 审计
- 指标收集
- HTTP 跟踪

Actuator 也可以和一些外部的应用监控系统整合（Prometheus, Graphite, DataDog, Influx, Wavefront, New Relic等）。这些监控系统提供了出色的仪表板，图形，分析和警报，可帮助你通过一个统一友好的界面，监视和管理你的应用程序。

## Actuator开启与配置

### 监控开启

> 开启监控

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```



> 访问：http://localhost:8080/actuator/health

返回值是应用状态信息，包含四种状态`DOWN`(应用不正常), `OUT_OF_SERVICE`(服务不可用),`UP`(状态正常), `UNKNOWN`(状态未知)。

![image-20220415082856498](https://pic-go.oss-cn-shanghai.aliyuncs.com/typora-img/202204150828560.png)

### 端点配置

> 该监控端点的监控信息非常有限，如果想让展示信息更加丰富，可以做如下配置。

```yml
management:
  endpoint:
    health:
      show-details: always
```

![image-20220415083331983](https://pic-go.oss-cn-shanghai.aliyuncs.com/typora-img/202204150833025.png)

> 开放端点配置（exposure）

```yml
management:
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: beans,env,info,health
        exclude: mappings
```

### 自定的端点编写与配置

> 自定义端点信息

```java
package com.qzk.boot.config;

import lombok.AllArgsConstructor;
import lombok.Data;
import org.springframework.boot.actuate.endpoint.annotation.Endpoint;
import org.springframework.boot.actuate.endpoint.annotation.ReadOperation;
import org.springframework.context.annotation.Configuration;

/**
 * @Description TODO
 * @Date 2022-04-15-09-08
 * @Author Courage
 */
@Configuration
@Endpoint(id = "customEndpoint")
public class CustomEndpoint {
    @ReadOperation
    public ShopData getData(){
        return new ShopData("qzk","jiangsu");
    }

    @Data
    @AllArgsConstructor
    public static class ShopData{
        private String name;
        private String address;
    }
}
```

> 添加配置

![image-20220415102427793](https://pic-go.oss-cn-shanghai.aliyuncs.com/typora-img/202204151024848.png)

测试：

![image-20220415102523410](https://pic-go.oss-cn-shanghai.aliyuncs.com/typora-img/202204151025446.png)

### 其他一些可配置的端点信息

| **ID(监控端点名称)** | **描述** | **服务是否默认启用** |
| :--------------- | -------- | -------------------- |
| auditevents| 应用程序的审计事件相关信息|	Yes     |
|beans |	应用中所有Spring Beans的完整列表	Yes|
|conditions |	（configuration and auto-configuration classes）的状态及它们被应用或未被应用的原因 |	Yes|
|configprops	|@ConfigurationProperties的集合列表	|Yes|
|env|	Spring的 ConfigurableEnvironment的属性	|Yes|
|flyway	|flyway 数据库迁移路径，如果有的话|	Yes|
|liquibase|	Liquibase数据库迁移路径，如果有的话	|Yes|
|metrics|	应用的metrics指标信息|	Yes|
|mappings|	所有@RequestMapping路径的集合列表|	Yes|
|scheduledtasks|	应用程序中的计划任务	|Yes|
|sessions|	允许从Spring会话支持的会话存储中检索和删除(retrieval and deletion)用户会话。使用Spring Session对反应性Web应用程序的支持时不可用。	|Yes|
|shutdown|	允许应用以优雅的方式关闭（默认情况下不启用）|	No|
|threaddump|	线程名、线程ID、线程的状态、是否等待锁资源、线程堆栈等信息|	Yes|
|httptrace显示|	HTTP跟踪信息（默认显示最后100个HTTP请求 - 响应交换）|	Yes|



## 整合SpringBoot Admin界面监控

### 简介

Spring Boot Admin是一个针对Spring Boot Actuator的JSON数据响应结果进行UI美化封装的监控工具，通过Spring Boot Admin，可以在可视化页面中浏览所有被监控的spring-boot项目的Actuator运行时信息，甚至还可以直接修改logger的level。

Spring Boot Admin包括客户端和服务端两个部分，一个服务端可以展示多个客户端的监控结果：

客户端：即需要监控的应用服务，需集成spring-boot-admin-starter-client,通过HTTP协议注册到Spring Boot Admin服务端,从而进行集中展示。（也可以结合Spring Cloud服务注册中心）

 服务端：访问客户端的Actuator运行时数据，并使用UI界面进行展示。是一个独立的Spring Boot应用,需集成spring-boot-admin-starter-server,



### 客户端配置

> 添加依赖

```xml
 <dependency>
     <groupId>org.springframework.boot</groupId>
     <artifactId>spring-boot-starter-actuator</artifactId>
 </dependency>
 <dependency>
     <groupId>de.codecentric</groupId>
     <artifactId>spring-boot-admin-starter-client</artifactId>
     <version>2.6.4</version>
 </dependency>
```

> 在application.yml中配置注册信息

```yml
spring:
  boot:
    admin:
      client:
      	##服务端的url
        url: http://localhost:8081
        ##客户端实例信息
        instance:
          ##客户端的访问url
          service-base-url: http://localhost:8080
          ##客户端的name
          name: "测试应用注册"
##客户端的端点配置
management:
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
      ##'*'表示暴露所有，需要带单引号
        include: '*'
```

`启动服务，客户端的配置就完成了!`

### 服务端的配置

> 添加依赖

```xml
<dependency>
     <groupId>de.codecentric</groupId>
     <artifactId>spring-boot-admin-starter-server</artifactId>
     <version>2.6.4</version>
</dependency>
```

> 在启动类上加上注解@EnableAdminServer，开启AdminServer

![image-20220415103555656](https://pic-go.oss-cn-shanghai.aliyuncs.com/typora-img/202204151035702.png)

> 配置服务端口和上文客户端指定的服务端口一致

![image-20220415103639458](https://pic-go.oss-cn-shanghai.aliyuncs.com/typora-img/202204151036493.png)

> 启动项目：访问`http://localhost:8081/applications`

![image-20220415103738487](https://pic-go.oss-cn-shanghai.aliyuncs.com/typora-img/202204151037586.png)
